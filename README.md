# 煤矸石图像语义分割任务实验报告

### 2. 方法

#### (1). 模型架构

输入图片经过resize至480x480大小，并进行标准化及归一化，以ResNet的基础残差块作为特征提取部分的主框架，每个残差块具有两个3x3卷积层，卷积层中间采用Batch Normalization层和ReLU激活层，输入经过1x1卷积达到同维度后，与两个3x3卷积的结果相加后经过ReLU激活。在叠加5个残差块后，使用全局平均池化，得到2x2x1024维的结果。经过4组2x(反卷积+BN+ReLU+上采样)的网络，得到384x384x3的矩阵，经过softmax得到最终每个像素点的3个类别得分。

![image-20220316205055229](%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A.assets/image-20220316205055229-16474350571162.png)

<center>Fig. 3 模型架构 </center> 

#### (2). 数据处理

采用煤矸石RGB图片作为训练及验证测试数据，区域颜色图片标注作为标签。训练集共计200张图片，测试集共计36张图片。训练数据输入网络前需要进行resize和归一化、标准化处理，将原始尺寸为480x852的煤矸石图片缩小至480x480大小，再将像素值从0\~255归一化到0~1，并计算出数据集均值方差分别为[0.2990, 0.2990, 0.2990], [0.1037, 0.1037, 0.1037]，以此数据进行标准化操作。标签图片根据像素点颜色生成类别one-hot矩阵，分别为背景、煤炭、矸石三个类别。

由于训练集图片数量较少，网络学习较困难，因此在训练过程中，随机加入水平翻转和随机裁剪两种数据扩增方法，提高网络泛化能力，防止对训练集过拟合。

#### (3). 训练

在pytorch框架下， 通过其Dataset和dataloader类加载训练和验证数据，同时针对训练数据进行一定概率的随机扩增。由于数据集较小，实验过程发现batch size设置为4时效果较好。模型loss计算采用交叉熵损失函数，使用SGD优化器，同时设置学习率衰减，使学习率随着训练过程增加逐渐减小，后期学习效果更好，加速收敛并减少震荡。在每个epoch统计训练集损失、验证集损失和总体精度，训练过程如图所示。

![loss](%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A.assets/loss-16475669557611.jpg)

<center>Fig. 4 训练过程</center>

在模型训练实验中，根据验证集的PR曲线和实际结果，不断迭代调整超参数和模型架构，来获得更好的验证集效果。

### 3. 结果

经过多次参数调优和迭代训练，得到模型在测试集上进行验证，设置不同threshold从0.01至0.99共200个阈值，分别统计tp/fp/fn/tn，并计算precision和recall，以及fpr和tpr，最终获取如图所示PR曲线、ROC曲线，其中由于背景类别占比大且易于分辨，因此精度和召回率较高，相对于煤和矸石类别作为前景类别，精度和召回率相对较低。

<div align=center><img src = "%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A.assets/prROC.png"></div>

<center>Fig. 4 PR曲线和ROC曲线</center>

根据模型结果，对每一像素点的三类得分取最大值作为预测类别，形成最终语义分割结果，并计算煤炭像素个数相对前景像素个数占比，如图所示。

![val-res](%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A.assets/图片1.png)

<center>Fig. 5 验证集效果示例（由上至下：模型预测、数据真值、实际图片）</center>

![val-res](%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A.assets/图片2.png)

<center>Fig. 6 训练集效果示例（由上至下：模型预测、数据真值、实际图片）</center>

